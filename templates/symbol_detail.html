<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>{{ data.name or data.base_symbol }} | جزئیات ارز</title>
    <style>
        body { font-family: sans-serif; direction: rtl; background: #f5f5f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ddd; max-width: 600px; margin: auto; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #ddd; text-align: center; }
        .green { color: green; font-weight: bold; }
        .red { color: red; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <div class="card">
        <h1>{{ data.name or data.base_symbol }}</h1>
        <p>نماد پایه: {{ data.base_symbol }}</p>
        <p>قیمت فعلی: {{ data.price }} </p>
        <p>
            <strong>تغییر قیمت:</strong>
            <span style="color: {{ data.color }};">
              {{ data.price_change_str }}
            </span>
          </p>
        <p>امتیاز برای ترید کوتاه مدت و لحظه ای: {{ data.score }}</p>
        <p style="color: {% if data.score < 0%}red{% elif data.score > 0 %}green{% endif %}">{% if data.score < 0%}پیشنهاد بررسی معامله شورت{% elif data.score > 0 %}پیشنهاد بررسی معامله لانگ{%else %}محدوده خنثی{% endif %}</p>
        <p>آخرین بروزرسانی: {{ data.updated_at }}</p>

        <table>
            <thead>
                <tr>
                    <th>تایم‌فریم</th>
                    <th>RSI</th>
                    <th> روند</th>
                    <th>تغییرات</th>
                    <th>چارت</th>
                </tr>
            </thead>
            <tbody>
                {% set timeframes = [
                    ('1m', '1 دقیقه', data.rsi_1m, data.rsi_trend_1m, data.rsi_change_1m ),
                    ('5m', '5 دقیقه', data.rsi_5m, data.rsi_trend_5m, data.rsi_change_5m ),
                    ('15m', '15 دقیقه', data.rsi_15m, data.rsi_trend_15m, data.rsi_change_15m ),
                    ('1h', '1 ساعت', data.rsi_1h, data.rsi_trend_1h, data.rsi_change_1h ),
                    ('4h', '4 ساعت', data.rsi_4h, data.rsi_trend_4h , data.rsi_change_4h )
                ] %}
                {% for tf_key, tf_label, rsi_val,rsi_trend , rsi_change in timeframes %}

                <tr>
                    <td>{{ tf_label }}</td>
                    <td class="{% if rsi_val > 70 %}red{% elif rsi_val < 30 %}green{% endif %}">
                        {{ "%.2f"|format(rsi_val) if rsi_val else '-' }}
                    </td>
                    <td>{{ rsi_trend }}</td>
                    <td class="{% if rsi_change > 0 %}green{% elif rsi_change < 0 %}red{% endif %}">
                        {{ "%.2f"|format(rsi_change) if rsi_change else '-' }}
                    </td>
                    <td><div class="chart-container">
                        <canvas id="chart-{{ tf_key }}"></canvas>
                    </div></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <a href="/">⬅ بازگشت به لیست</a>
    </div>



    <script>
        const chartData = {{ chart_data | tojson }};

        function formatTime(timestamp, timeframe) {
            const date = new Date(timestamp);
            if (timeframe === '1m' || timeframe === '5m') {
                return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            }
        }

        function createChart(canvasId, timeframe, data) {
            if (!data || !data.rsi_values || data.rsi_values.length === 0) return;
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.timestamps.map(t => formatTime(t, timeframe)),
                    datasets: [{
                        label: 'RSI',
                        data: data.rsi_values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 1,
                        pointHoverRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 70) return 'rgba(239, 68, 68, 0.3)';
                                    if (context.tick.value === 30) return 'rgba(34, 197, 94, 0.3)';
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        },
                        x: {
                            ticks: { maxTicksLimit: 20 }
                        }
                    }
                }
            });
        }

        ['1m', '5m', '15m', '1h', '4h'].forEach(tf => {
            if (chartData[tf]) {
                createChart('chart-' + tf, tf, chartData[tf]);
            }
        });
    </script>


</body>
</html>
